<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." default="release.j2se.bin" name="SGS">

    <target name="help">
	<echo message="Please run: $ ant -v -projecthelp" />
    </target>

    <property name="debug" value="true" />
    <property name="optimize" value="true" />
    <property name="deprecated" value="true" />

    <property name="jrms.version" value="1.1" />
    <property name="jrms.jarfile" value="jrms/jrms-${jrms.version}.jar" />
    <property name="derby.version" value="10.1.2.1" />
    <property name="derby.jarfile" value="derby/derby-${derby.version}.jar" />

    <path id="project.classpath">
	<pathelement location="bin" />
	<pathelement location="resources/libs/${jrms.jarfile}" />
	<pathelement location="resources/libs/${derby.jarfile}" />
	<pathelement location="resources/libs/servlet/javax.servlet.jar" />
	<pathelement location="resources/libs/servlet/commons-logging.jar" />
	<pathelement location="resources/libs/servlet/org.mortbay.jetty.jar" />
    </path>

    <target name="init">
        <mkdir dir="bin"/>
        <mkdir dir="doc"/>
        <mkdir dir="release"/>
    	<mkdir dir="release/apps"/>
    	<mkdir dir="release/apps/trivial_boot"/>
    	<mkdir dir="release/apps/battleboard"/>
    	<mkdir dir="release/apps/chat_test"/>
    	<mkdir dir="release/apps/matchmaker"/>
    	<mkdir dir="release/apps/timer_test"/>
    	<mkdir dir="release/apps/jeffboard"/>
    	<mkdir dir="release/apps/glotest"/>
    	<mkdir dir="release/apps/jnwn"/>
    	<mkdir dir="release/client"/>
    	<mkdir dir="release/derby"/>
    	<mkdir dir="release/jrms"/>
    	<mkdir dir="release/examples"/>
    	<mkdir dir="doc/doxygen" />
    </target>

    <target name="clean">
	<delete dir="bin" />
	<delete quiet="true">
	    <fileset dir="release" includes="**/*.jar"/>
	</delete>
    </target>

    <target name="clean.j2meAPI">
	<ant dir="J2MEAPI/J2MEClientAPI" target="clean" /> 
    </target>

    <target name="realclean" depends="clean,clean.j2meAPI">
	<delete dir="doc" />
	<delete dir="release" />
	<delete file="ProjectDarkstar.zip" />
    </target>

    <!-- Documentation targets -->

    <target name="docs" depends="javadocs,doxygen" />

    <target name="doxygen" depends="doxygen-internal,doxygen-api" />

    <target name="doxygen-api" depends="init">
	<exec executable="doxygen" failonerror="true">
	    <arg value="java-client-api.doxygen" />
	</exec>
	<exec executable="doxygen" failonerror="true">
	    <arg value="java-server-api.doxygen" />
	</exec>
	<exec executable="doxygen" failonerror="true">
	    <arg value="java-stackext-api.doxygen" />
	</exec>
    </target>

    <target name="doxygen-internal" depends="init">
	<exec executable="doxygen" failonerror="true">
	    <arg value="java.doxygen" />
	</exec>
    </target>

    <target name="javadocs" depends="javadocs-internal,javadocs-api" />

    <target name="javadocs-internal" depends="init">
	<javadoc destdir="doc/javadoc/internal" sourcepath="src"
		classpathref="project.classpath" access="private">
	    <package name="com.sun.gi.*" />
	    <tag name="todo" description="To do:" />
	</javadoc>
    </target>

    <target name="javadocs-api" depends="init">
	<javadoc destdir="doc/javadoc/api" sourcepath="src"
		classpathref="project.classpath" access="public">
	    <package name="com.sun.gi.*" />
	    <tag name="todo" description="To do:" />
	</javadoc>
    </target>

    <!-- Compilation targets -->

    <target name="build.server" depends="init">
	<javac srcdir="src" destdir="bin" source="5" target="5"
		debug="${debug}" optimize="${optimize}"
		deprecation="${deprecated}">
	    <!-- <compilerarg value="-Xlint:unchecked"/> -->
	    <classpath refid="project.classpath" />
	    <exclude name="com/sun/gi/apps/**" />
	    <exclude name="com/sun/gi/client/**" />
	</javac>
    </target>


    <target name="build.j2seAPI" depends="init">
	<javac srcdir="src" sourcepath="" destdir="bin" source="5" target="5"
		debug="${debug}" optimize="${optimize}"
		deprecation="${deprecated}">
	    <compilerarg value="-Xlint:unchecked"/>
	    <classpath refid="project.classpath" />
	    <include name = "com/sun/gi/comm/users/client/**" />
	    <include name = "com/sun/gi/comm/users/protocol/**" />
	    <include name = "com/sun/gi/validation/**" />
	    <include name = "com/sun/gi/comm/discovery/**" />
	    <include name = "com/sun/gi/utils/nio/**" />
	    <include name = "com/sun/gi/utils/types/**" />
	</javac>
    </target>

    <target name="build.j2meAPI" depends="init">
        <ant dir="J2MEAPI/J2MEClientAPI" target="jar"/>
    </target>

    <target name="build.clients" depends="build.j2seAPI">
	<javac srcdir="src" destdir="bin" source="5" target="5"
		debug="${debug}" optimize="${optimize}"
		deprecation="${deprecated}">
	    <!-- <compilerarg value="-Xlint:all"/> -->
	    <classpath refid="project.classpath" />
	    <include name="com/sun/gi/apps/**" />
	    <exclude name="com/sun/gi/apps/*/*.java" />
	    <exclude name="com/sun/gi/apps/**/server/**" />
	    <include name="com/sun/gi/client/**" />
	</javac>
    </target>

    <target name="build.chat" depends="init">
	<javac srcdir="src" destdir="bin" source="5" target="5"
		debug="${debug}" optimize="${optimize}"
		deprecation="${deprecated}">
	    <!-- <compilerarg value="-Xlint:unchecked"/> -->
	    <classpath refid="project.classpath" />
	    <include name="com/sun/gi/apps/chattest/ChatTestBoot.java" />
	</javac>
    </target>

    <target name="build.trivial" depends="init">
	<javac srcdir="src" destdir="bin" source="5" target="5"
		debug="${debug}" optimize="${optimize}"
		deprecation="${deprecated}">
	    <compilerarg value="-Xlint:all"/>
	    <classpath refid="project.classpath" />
	    <include name="com/sun/gi/apps/trivial/TrivialBoot.java" />
	</javac>
    </target>

    <target name="build.timertest" depends="init">
	<javac srcdir="src" destdir="bin" source="5" target="5"
		debug="${debug}" optimize="${optimize}"
		deprecation="${deprecated}">
	    <!-- <compilerarg value="-Xlint:unchecked"/> -->
	    <classpath refid="project.classpath" />
	    <include name="com/sun/gi/apps/timertest/**" />
	</javac>
    </target>

    <target name="build.battleboard" depends="init">
	<javac srcdir="src" destdir="bin" source="5" target="5"
		debug="${debug}" optimize="${optimize}"
		deprecation="${deprecated}">
	    <compilerarg value="-Xlint:all"/>
	    <classpath refid="project.classpath" />
	    <include name="com/sun/gi/apps/battleboard/server/**" />
	</javac>
    </target>

    <target name="build.jeffboard" depends="init">
	<javac srcdir="src" destdir="bin" source="5" target="5"
		debug="${debug}" optimize="${optimize}"
		deprecation="${deprecated}">
	    <!-- <compilerarg value="-Xlint:unchecked"/> -->
	    <classpath refid="project.classpath" />
	    <include name="com/sun/gi/apps/jeffboard/**" />
	</javac>
    </target>

    <target name="build.matchmaker" depends="init">
	<javac srcdir="src" destdir="bin" source="5" target="5"
		debug="${debug}" optimize="${optimize}"
		deprecation="${deprecated}">
	    <!-- <compilerarg value="-Xlint:unchecked"/> -->
	    <classpath refid="project.classpath" />
	    <include name="com/sun/gi/apps/mcs/matchmaker/server/**" />
	</javac>
    </target>

    <target name="build.glotest" depends="init">
	<javac srcdir="src" destdir="bin" source="5" target="5"
		debug="${debug}" optimize="${optimize}"
		deprecation="${deprecated}">
	    <compilerarg value="-Xlint:all"/>
	    <classpath refid="project.classpath" />
	    <include name="com/sun/gi/apps/glotest/*.java" />
	</javac>
    </target>

    <target name="build.jnwn" depends="init">
	<javac srcdir="src" destdir="bin" source="5" target="5"
		debug="${debug}" optimize="${optimize}"
		deprecation="${deprecated}">
	    <compilerarg value="-Xlint:all"/>
	    <classpath refid="project.classpath" />
	    <classpath location="NWNSupport.jar"/>
	    <classpath location="/usr/share/java/java3d/j3dutils.jar"/>
	    <include name="com/sun/gi/apps/jnwn/**" />
	</javac>
    </target>

    <!-- Runnable Servers -->

    <target name="SGS-clean">
	<java dir="release" classname="com.sun.gi.SGS" failonerror="true" fork="yes">
	    <arg value="-C"/>
	    <arg value="-V"/>
	    <classpath refid="project.classpath"/>
	    <sysproperty key="java.util.logging.config.file"
			 file="logging.properties"/>
	</java>
    </target>

    <target name="SGS-jnwn-clean">
	<java dir="release" classname="com.sun.gi.SGS" failonerror="true" fork="yes">
	    <arg value="-C"/>
	    <arg value="-V"/>
	    <arg value="-I"/>
	    <arg value="file:JNWN-server.txt" />
	    <classpath refid="project.classpath"/>
	    <classpath location="NWNSupport.jar"/>
	    <classpath location="genesisfx.jar"/>
	    <classpath location="/usr/share/java/java3d/j3dcore.jar"/>
	    <classpath location="/usr/share/java/java3d/j3dutils.jar"/>
	    <classpath location="/usr/share/java/java3d/vecmath.jar"/>
	    <sysproperty key="jnwn.data.dir" path="/u01/nwn"/>
	    <sysproperty key="java.util.logging.config.file"
			 file="logging.properties"/>
	</java>
    </target>

    <target name="SGS">
	<java dir="release" classname="com.sun.gi.SGS" failonerror="true" fork="yes">
	    <arg value="-V" />
	    <classpath refid="project.classpath" />
	    <sysproperty key="java.util.logging.config.file"
			 file="logging.properties" />
	</java>
    </target>

    <target name="SGS2">
	<java dir="release" classname="com.sun.gi.SGS" failonerror="true" fork="yes">
	    <arg value="-I"/>
	    <arg value="file:Install2.txt" />
	    <classpath refid="project.classpath" />
	    <sysproperty key="java.util.logging.config.file"
			 file="logging.properties" />
	</java>
    </target>

    <!-- Runnable Clients -->

    <target name="ChatTest">
	<java classname="com.sun.gi.apps.commtest.client.ChatTestClient"
		failonerror="true" fork="yes">
	    <classpath refid="project.classpath" />
	    <sysproperty key="java.util.logging.config.file"
			 file="logging.properties" />
	</java>
    </target>

    <target name="ChatTest2">
	<java classname="com.sun.gi.apps.commtest.client.ChatTestClient"
		failonerror="true" fork="yes">
	    <classpath refid="project.classpath" />
	    <sysproperty key="java.util.logging.config.file"
			 file="logging.properties" />
	</java>
    </target>

    <target name="BattleBoard">
	<echo message="BROKEN!  Ant on Linux won't let us input on stdin"/>
	<java jar="release/BattleBoardClient.jar" failonerror="true" fork="true">
	    <sysproperty key="java.util.logging.config.file"
			 file="logging.properties" />
	</java>
    </target>

    <target name="MatchMakerClientTestUI">
	<java classname="com.sun.gi.apps.mcs.matchmaker.client.test.MatchMakerClientTestUI" failonerror="true" fork="true">
	    <classpath refid="project.classpath" />
	    <sysproperty key="java.util.logging.config.file"
			 file="logging.properties" />
	</java>
    </target>

    <target name="DIRC">
	<java classname="com.sun.gi.client.dirc.DIRC"
		failonerror="true" fork="true">
	    <classpath refid="project.classpath" />
	    <sysproperty key="java.util.logging.config.file"
			 file="logging.properties" />
	</java>
    </target>

    <!-- Release Targets -->

    <target name="release" depends="release.j2se,release.j2me">
	<zip destfile="ProjectDarkstar.zip" basedir="release" />
    </target>

    <!-- J2SE release targets -->

    <target name="release.j2se" depends="release.j2se.bin,release.docs,release.examples"/>

    <target name="release.j2se.bin" depends="release.server,release.j2seAPI,release.apps,release.clients"/>

    <target name="release.server" depends="build.server">
	<jar destfile="release/ProjectDarkstar.jar">
	    <manifest>
		<attribute name="Class-Path"
			   value="${jrms.jarfile} ${derby.jarfile}"/>
		<attribute name="Main-Class"
			   value="com.sun.gi.SGS"/>
	    </manifest>
	    <fileset dir="bin">
		<exclude name="com/sun/gi/apps/**"/>
		<exclude name="com/sun/gi/client/**"/>
		<exclude name="com/sun/gi/comm/users/client/**"/>
	    </fileset>
	</jar>
	<copy file="resources/startDarkstar.sh" todir="release" />
	<copy file="resources/startDiscovery.sh" todir="release" />
	<chmod file="release/startDarkstar.sh" perm="755" />
	<chmod file="release/startDiscovery.sh" perm="755" />
	<copy file="resources/libs/${jrms.jarfile}" todir="release/jrms" />
	<copy file="resources/libs/${derby.jarfile}" todir="release/derby" />
	<copy file="resources/Install.txt" todir="release" />
	<copy file="resources/passwd.txt" todir="release" />
    <copy file="resources/FakeDiscovery.xml" todir="release" />
    </target>

    <target name="release.j2seAPI" depends="build.j2seAPI">
	<jar destfile="release/ProjectDarkstarClientAPI.jar">
	    <fileset dir="bin">
		<include name="com/sun/gi/comm/users/client/**"/>
		<include name="com/sun/gi/comm/users/protocol/**"/>
		<include name="com/sun/gi/validation/**"/>
		<include name="com/sun/gi/comm/discovery/**"/>
		<include name="com/sun/gi/utils/nio/**"/>
		<include name="com/sun/gi/utils/types/**"/>
	    </fileset>
	</jar>
    </target>
	
    <target name="release.docs" depends="docs">
	<copy todir="release/docs" >
	    <fileset dir="doc/doxygen">
		<exclude name="internal/**" />
	    </fileset>
	</copy>
    </target>

    <target name="release.clients" depends="release.client.battleboard,release.client.other"/>

    <target name="release.client.other" depends="build.clients"/>

    <target name="release.client.battleboard" depends="build.clients">
	<jar destfile="release/client/BattleBoardClient.jar">
	    <manifest>
		<attribute name="Class-Path"
			   value="../ProjectDarkstarClientAPI.jar"/>
		<attribute name="Main-Class"
			   value="com.sun.gi.apps.battleboard.client.BattleBoardClient"/>
	    </manifest>
	    <fileset dir="bin">
		<include name="com/sun/gi/apps/battleboard/*.class"/>
		<include name="com/sun/gi/apps/battleboard/client/**"/>
	    </fileset>
	    <fileset dir="src">
		<include name="com/sun/gi/apps/battleboard/client/swing/imgs/**"/>
	    </fileset>
	</jar>
    </target>

    <target name="release.apps"
	depends="release.trivialboot,release.timertest,release.chattest,release.jeffboard,release.battleboard,release.glotest,release.matchmaker">
    </target>

    <target name="release.trivialboot" depends="build.trivial">
	<jar destfile="release/apps/trivial_boot/trivial_boot.jar"
	    basedir="bin" includes="com/sun/gi/apps/trivial/**" />
	<copy file="resources/trivial_boot_deployment.xml"
	    todir="release/apps/trivial_boot" />
    </target>

    <target name="release.chattest" depends="build.chat">
	<jar destfile="release/apps/chat_test/ChatTest.jar"
	    basedir="bin" includes="com/sun/gi/apps/chattest/ChatTestBoot.class" />
	<copy file="resources/chat_test_deployment.xml"
	    todir="release/apps/chat_test" />
    </target>

    <target name="release.battleboard" depends="build.battleboard">
	<jar destfile="release/apps/battleboard/BattleBoard.jar"
	    basedir="bin" includes="com/sun/gi/apps/battleboard/server/**" />
	<copy file="resources/battleboard_deployment.xml"
	    todir="release/apps/battleboard" />
    </target>

    <target name="release.glotest" depends="build.glotest">
	<jar destfile="release/apps/glotest/GLOTest.jar"
	    basedir="bin" includes="com/sun/gi/apps/glotest/*.class" />
	<copy file="resources/test_channel_race.xml"
	    todir="release/apps/glotest" />
    </target>

    <target name="release.jeffboard" depends="build.jeffboard">
	<jar destfile="release/apps/jeffboard/JeffBoard.jar"
	    basedir="bin" includes="com/sun/gi/apps/jeffboard/**" />
	<copy file="resources/jeffboard_deployment.xml"
	    todir="release/apps/jeffboard" />
    </target>

    <target name="release.matchmaker" depends="build.matchmaker">
	<jar destfile="release/apps/matchmaker/MatchMaker.jar"
	    basedir="bin" includes="com/sun/gi/apps/mcs/matchmaker/server/**" />
	<copy file="resources/matchmaker_deployment.xml"
	    todir="release/apps/matchmaker" />
	<copy file="resources/matchmaker_config.xml"
	    todir="release/apps/matchmaker" />
    </target>

    <target name="release.timertest" depends="build.timertest">
	<jar destfile="release/apps/timer_test/TimerTest.jar"
	    basedir="bin" includes="com/sun/gi/apps/timertest/**" />
	<copy file="resources/timer_test_deployment.xml"
	    todir="release/apps/timer_test" />
    </target>

    <target name="release.jnwn" depends="build.jnwn">
	<jar destfile="release/apps/jnwn/JNWN.jar"
	    basedir="bin" includes="com/sun/gi/apps/jnwn/**" />
	<copy file="resources/jnwn/deploy.xml"
	    todir="release/apps/jnwn" />
    </target>

    <target name="release.examples" >
	<zip destfile="release/Examples.zip" basedir="src"
	    includes="com/sun/gi/apps/chattest/**"/>
    </target>

    <!-- J2ME release targets -->

    <target name="release.j2me" depends="release.j2meAPI"/>

    <target name="release.j2meAPI" depends="build.j2meAPI">
	<copy todir="release" >
	    <fileset dir="J2MEAPI/J2MEClientAPI/dist" />
	</copy>	
    </target>

</project>
